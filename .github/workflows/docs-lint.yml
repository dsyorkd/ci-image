name: Documentation Lint

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - '.github/workflows/docs-lint.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - '.github/workflows/docs-lint.yml'

jobs:
  lint-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD022": false,
            "MD031": false,
            "MD032": false,
            "MD040": false,
            "MD047": false,
            "MD009": false
          }
          EOF

      - name: Lint main documentation files
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            README.md
            SECURITY.md
            CHANGELOG.md
            docs/**/*.md
            .taskmaster/docs/**/*.md

      - name: Check for broken links in main docs
        run: |
          echo "Checking for obviously broken relative links in README.md..."
          # Simple check for broken internal links (files that don't exist)
          if grep -oE '\]\([^)]+\.md\)' README.md | sed 's/.*](//' | sed 's/).*//' | while read link; do
            if [[ "$link" =~ ^[^/] ]] && [ ! -f "$link" ]; then
              echo "âŒ Broken relative link found: $link"
              exit 1
            fi
          done; then
            echo "âœ… No broken relative links found in README.md"
          fi

      - name: Validate Task Master export format
        run: |
          if grep -q "TASKMASTER_EXPORT_START" README.md; then
            echo "âœ… Task Master export format found"
            # Validate that export section is properly closed
            if ! grep -q "TASKMASTER_EXPORT_END" README.md; then
              echo "âŒ Task Master export section not properly closed"
              exit 1
            fi
            echo "âœ… Task Master export section is properly formatted"
          else
            echo "â„¹ï¸  No Task Master export found (this is OK)"
          fi

      - name: Check documentation structure  
        run: |
          echo "ðŸ“‹ Documentation structure check:"
          required_sections=(
            "Project Overview"
            "Image Architecture" 
            "Quick Start"
            "License"
          )
          
          missing_sections=()
          for section in "${required_sections[@]}"; do
            if grep -q "## .*${section}" README.md; then
              echo "âœ… Found: $section"
            else
              echo "âŒ Missing: $section"
              missing_sections+=("$section")
            fi
          done
          
          if [ ${#missing_sections[@]} -gt 0 ]; then
            echo "âŒ Missing required sections in README.md"
            exit 1
          fi
          
          echo "âœ… All required documentation sections present"